# 训练器

训练器是负责模型训练和评估过程的主体，并且还负责组件构造、检查点加载与保存等任务，是本项目中逻辑较为复杂、与其它模块耦合度较高的部分。

## 基础训练器

抽象基类 `Trainer` 在 `src/core/trainer.py` 中定义，是训练器最基础的原型。`Trainer` 是 epoch-based 的，在每个 epoch 都会依次执行 `train_epoch` 和 `evaluate_epoch` 这两个方法，分别对应模型在这个 epoch 的训练和验证过程，继承此基类的子类必须重写 `train_epoch` 和 `evaluate_epoch` 方法，否则无法实例化。此外，`Trainer`中还实现了组件构造、检查点加载与保存、学习率调整等功能。

### 检查点加载

`_resume_from_checkpoint` 方法具有如下功能：训练阶段，加载**完全匹配或部分匹配**的检查点，汇报成功载入的参数个数，并返回载入状态；验证阶段，除非检查点的 state_dict 中完整地包含模型所有的参数（不要求完全匹配，检查点中也可以包含更多其它参数），否则返回 `False` 表示载入失败。除此之外，在训练阶段，也支持和非本项目生成的检查点的匹配，但要求该检查点的 state_dict **直接**包含模型的 state_dict，而不能将模型的 state_dict 存储为某个键值的 value。

此外，当 `anew` 配置项被设置为 `True` 时，检查点将只被用于初始化模型参数，而训练将仍从第0个 epoch 开始。配合 `anew` 与 `resume` 配置项可以实现加载预训练权重的功能。

### 检查点存储

`_save_checkpoint` 方法用于写入检查点。该方法接收的输入参数有：模型的状态字典、优化器的状态字典、截至当前最好精度和对应 epoch、当前epoch编号以及一个表征当前模型是否为历史最好模型的 flag。该方法将构造一个字典写入检查点，字典中包含4个键值对，分别对应当前epoch编号、模型的状态字典、优化器状态字典、截至当前最好精度和对应epoch。此外，该方法对最新的检查点存储一份拷贝；若当前模型为历史最好模型，则还将额外存储一个检查点。检查点文件的命名模板可以在 `src/constants.py` 中定制。

需要注意的是，出于对旧版本的兼容性考虑，训练器在检查点的命名中使用的 epoch 编号为实际 epoch 编号（从0开始记）加上1。

### 学习率调整

如果需要使用自定义的学习率调度方式，可以继承 `Trainer` 或其子类并重写 `init_learning_rate` 和 `adjust_learning_rate` 方法。前者在训练刚开始时执行，返回一个初始的学习率；后者在每个 epoch 结束时执行，返回一个调整后的学习率。

## 变化检测训练器

定义在 `src/impl/trainers/cd_trainer.py`。`CDTrainer` 是面向变化检测任务的训练器，对 `Trainer` 的关键方法进行了重写，并添加了 TensorBoard 日志和学习率调度器支持。项目中实际使用的各种训练器都继承自此基类，其中包括针对单通道输出+分类模型的`CDTrainer_BCE`、针对双通道输出+分类模型的`CDTrainer_NLL`以及针对单通道输出+度量学习模型的`CDTrainer_metric`等。

### 学习率调度器

`CDTrainer` 默认已经支持 PyTorch 原生的各种学习率调度器用于调整学习率。当配置项 `sched_on` 被设置为 `True` 时，在 `schedulers` 中可以以列表的形式指定与优化器数目相对应的学习率调度器。列表的每一项为一个字典，其中必须包含一个 `name` 字段表示调度器类名，而剩下的键值对则分别对应调度器对象构造时的输入参数名和取值。

### 钩子

针对变化检测任务，暴露4个方法供子类重写，分别对应4种可扩展的关键行为。

- `_prepare_data`: 输入为两个时相影像以及真值标签，返回对这三者的处理结果。例如，在这个方法中可以调整真值标签的数据类型（见 `src/impl/trainer/cd_trainer_bce.py` 中的实现）。
- `_set_fetch_dict`: 返回一个字典类型对象，用于模型一些中间层的可视化。`fetch_dict` 相关内容可参考[此处](./其它.md#`HookHelper`)。
- `_process_model_out`: 接受模型输出作为输入，将其转换为可以送入损失函数计算的对象。例如，当模型输出为一个列表，可以只取列表的第一项计算损失。
- `_pred_to_prob`: 将输入对象转换为概率图。这里的概率图指的是一个三维 `torch.Tensor` 对象，其取值范围须在 0-1 之间（满足概率的定义）。

将这些扩展行为设计为训练器方法的初衷是：本项目希望减低对模型本身的抽象，从而减少编写模型代码时的限制，使开发者能更专注模型本身，而不需要实现各种额外的接口。项目作者认为，在训练器中关于训练流程的逻辑里实现这些额外的转换行为是更加直观的。

## 训练器选择器

针对不同模型，项目中实现了许多不同的训练器。在程序运行时，通过训练器选择器确定应该使用哪一种训练器。训练器选择器内部维护一个列表，列表中的每一项包含一个判定条件和一个训练器类。一个判定条件指的是一个可调用对象，这个对象在被调用时以配置字典为输入，返回一个可以作为 `if` 判断条件的对象。训练器选择器工作时将内部维护的列表从后向前遍历（因此列表中靠后的项具有更高的优先级），对于列表中的每一项，如果其判断条件为真，则选用这个训练器类。
